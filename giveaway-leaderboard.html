<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - InstelTech Giveaway</title>
    <meta name="robots" content="noindex, nofollow" />
    <script src="env-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nerve: {
                            50: '#f0f5fa', 100: '#dae4f0', 200: '#b5c9e0', 300: '#8badc9',
                            400: '#6090b0', 500: '#3d7097', 600: '#2a5578', 700: '#1e3a5f',
                            800: '#162a42', 900: '#0f1d2e', 950: '#070e18',
                        },
                        primary: { DEFAULT: '#dc2626', dark: '#b91c1c', light: '#ef4444' },
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                }
            }
        }
    </script>
</head>
<body class="bg-nerve-900 font-sans text-nerve-900 min-h-screen">
    <div class="max-w-3xl mx-auto px-4 py-8">

        <div class="text-center text-white mb-8">
            <h1 class="text-3xl font-black mb-2">Giveaway <span class="text-primary">Leaderboard</span></h1>
            <p class="text-sm text-slate-400">Top referrers competing for the AI WhatsApp Business Assistant</p>
        </div>

        <div class="bg-primary rounded-xl p-4 text-center text-white mb-6 max-w-md mx-auto">
            <p class="text-xs font-semibold mb-2 uppercase tracking-wider opacity-80">Time Remaining</p>
            <div class="flex justify-center gap-4 text-xl font-black">
                <span><span id="daysLeft">--</span>d</span>
                <span><span id="hoursLeft">--</span>h</span>
                <span><span id="minutesLeft">--</span>m</span>
            </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
            <div class="bg-white rounded-xl p-4 text-center">
                <p id="totalEntries" class="text-2xl font-black text-nerve-900">0</p>
                <p class="text-[10px] text-slate-500 font-semibold uppercase">Entries</p>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
                <p id="qualifiedEntries" class="text-2xl font-black text-nerve-900">0</p>
                <p class="text-[10px] text-slate-500 font-semibold uppercase">Qualified</p>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
                <p id="totalReferrals" class="text-2xl font-black text-nerve-900">0</p>
                <p class="text-[10px] text-slate-500 font-semibold uppercase">Referrals</p>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
                <p class="text-2xl font-black text-primary">$2,500</p>
                <p class="text-[10px] text-slate-500 font-semibold uppercase">Prize</p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-white text-lg font-bold text-center mb-4">Top Referrers</h2>
            <div id="leaderboardContent">
                <div class="text-center py-12 text-slate-400">
                    <i class="fas fa-spinner fa-spin text-3xl mb-3 block"></i>
                    <p class="text-sm">Loading leaderboard...</p>
                </div>
            </div>
        </div>

        <div class="bg-emerald-600 rounded-xl p-6 text-center text-white">
            <h3 class="text-lg font-bold mb-2">Haven't Entered Yet?</h3>
            <p class="text-sm text-emerald-100 mb-4">Join the competition for a chance to win the $2,500 AI Business Assistant!</p>
            <a href="giveaway.html" class="inline-flex items-center gap-2 bg-white text-emerald-700 px-5 py-2.5 rounded-lg font-bold text-sm hover:-translate-y-0.5 transition-all">
                <i class="fas fa-rocket"></i> Enter Now - Free
            </a>
        </div>
    </div>

    <script>
        var SUPABASE_URL = window.VITE_SUPABASE_URL || '';
        var SUPABASE_KEY = window.VITE_SUPABASE_ANON_KEY || '';
        var GIVEAWAY_END_DATE = null;

        function fetchEndDate() {
            if (!SUPABASE_URL || !SUPABASE_KEY) {
                GIVEAWAY_END_DATE = new Date('2026-02-17T00:00:00Z');
                startCountdown();
                return;
            }
            fetch(SUPABASE_URL + '/rest/v1/giveaway_config?select=end_date&id=eq.1', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                GIVEAWAY_END_DATE = (data && data.length > 0 && data[0].end_date) ? new Date(data[0].end_date) : new Date('2026-02-17T00:00:00Z');
                startCountdown();
            })
            .catch(function() {
                GIVEAWAY_END_DATE = new Date('2026-02-17T00:00:00Z');
                startCountdown();
            });
        }

        function startCountdown() {
            function update() {
                if (!GIVEAWAY_END_DATE) return;
                var distance = GIVEAWAY_END_DATE.getTime() - Date.now();
                if (distance < 0) {
                    document.getElementById('daysLeft').textContent = '0';
                    document.getElementById('hoursLeft').textContent = '00';
                    document.getElementById('minutesLeft').textContent = '00';
                    return;
                }
                document.getElementById('daysLeft').textContent = Math.floor(distance / (1000 * 60 * 60 * 24));
                document.getElementById('hoursLeft').textContent = String(Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0');
                document.getElementById('minutesLeft').textContent = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
            }
            update();
            setInterval(update, 60000);
        }

        function loadLeaderboard() {
            if (!SUPABASE_URL || !SUPABASE_KEY) return;

            fetch(SUPABASE_URL + '/rest/v1/giveaway_entries?select=name,email,entry_score,created_at&order=entry_score.desc,created_at.asc&limit=50', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            })
            .then(function(res) { return res.json(); })
            .then(function(entries) {
                return fetch(SUPABASE_URL + '/rest/v1/giveaway_referrals?select=referrer_email', {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                })
                .then(function(res) { return res.json(); })
                .then(function(referrals) {
                    var referralCounts = {};
                    if (Array.isArray(referrals)) {
                        referrals.forEach(function(ref) {
                            referralCounts[ref.referrer_email] = (referralCounts[ref.referrer_email] || 0) + 1;
                        });
                    }
                    displayLeaderboard(entries, referralCounts);
                    loadStats(entries, referralCounts);
                });
            })
            .catch(function() {
                document.getElementById('leaderboardContent').innerHTML = '<div class="text-center py-12 text-slate-400"><i class="fas fa-exclamation-triangle text-2xl mb-3 block"></i><p class="text-sm">Unable to load. Try again later.</p></div>';
            });
        }

        function displayLeaderboard(entries, referralCounts) {
            var content = document.getElementById('leaderboardContent');
            if (!entries || entries.length === 0) {
                content.innerHTML = '<div class="text-center py-12 text-slate-400"><i class="fas fa-users text-2xl mb-3 block"></i><p class="text-sm">No entries yet. Be the first!</p></div>';
                return;
            }

            var html = '<div class="bg-white rounded-xl overflow-hidden">';
            html += '<div class="grid grid-cols-[50px_1fr_80px_60px] gap-2 bg-nerve-800 text-white text-xs font-bold px-4 py-3"><div>#</div><div>Name</div><div class="text-center">Score</div><div class="text-center">Refs</div></div>';

            entries.forEach(function(entry, i) {
                var rank = i + 1;
                var initial = entry.name.charAt(0).toUpperCase();
                var refs = referralCounts[entry.email] || 0;
                var rankLabel = rank <= 3 ? (rank === 1 ? '1st' : rank === 2 ? '2nd' : '3rd') : rank;
                var rankClass = rank <= 3 ? 'text-primary font-black' : 'text-slate-500';

                html += '<div class="grid grid-cols-[50px_1fr_80px_60px] gap-2 items-center px-4 py-3 border-b border-slate-100 text-sm">';
                html += '<div class="' + rankClass + '">' + rankLabel + '</div>';
                html += '<div class="flex items-center gap-2"><div class="w-7 h-7 rounded-full bg-nerve-100 flex items-center justify-center text-xs font-bold text-nerve-700">' + initial + '</div><span class="font-semibold text-nerve-900 truncate">' + entry.name.split(' ')[0] + '</span></div>';
                html += '<div class="text-center"><span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded-full">' + entry.entry_score + '</span></div>';
                html += '<div class="text-center text-slate-500 text-xs font-semibold">' + refs + '</div>';
                html += '</div>';
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function loadStats(entries, referralCounts) {
            document.getElementById('totalEntries').textContent = entries.length;
            document.getElementById('qualifiedEntries').textContent = entries.filter(function(e) { return e.entry_score >= 10; }).length;
            var totalRefs = 0;
            Object.keys(referralCounts).forEach(function(key) { totalRefs += referralCounts[key]; });
            document.getElementById('totalReferrals').textContent = totalRefs;
        }

        window.addEventListener('DOMContentLoaded', function() {
            fetchEndDate();
            loadLeaderboard();
            setInterval(loadLeaderboard, 30000);
        });
    </script>
</body>
</html>